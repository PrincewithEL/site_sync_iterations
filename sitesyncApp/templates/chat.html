<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Site Sync - {{ type }} Module - Chat Page</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
       {% load static %}
         {% include 'chatbot.html' %}
         {% csrf_token %}
    <!-- Bootstrap 3.3.2 -->
    <link href="{% static 'dashboard/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" type="text/css" />
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    <!-- FontAwesome -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Emojionearea -->
    <link rel="stylesheet" href="{% static 'dashboard/dist/css/emojionearea.min.css' %}">
    <script src="{% static 'dashboard/dist/js/emojionearea.min.js' %}"></script>
    <!-- Theme style -->
    <link href="{% static 'dashboard/dist/css/sitesync.css' %}" rel="stylesheet" type="text/css" />
    <!-- Skins -->
    <link href="{% static 'dashboard/dist/css/skins/skin-black.min.css' %}" rel="stylesheet" type="text/css" />
    <!-- Bootstrap WYSIHTML5 -->
    <link href="{% static 'dashboard/plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css' %}" rel="stylesheet" type="text/css" />
  </head>
      <style>
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }
        
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        .dropdown:hover .dropbtn {
            background-color: orange;
        }
        
        .dropbtn {
            background-color: white;
            color: black;
            padding: 5px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            width: 200px;
            text-align: left;
        }
        .custom-checkbox {
    display: block !important;
    margin: auto;
    width: 16px;
    height: 16px;
}
    </style>
    <style>
    .message-actions {
        display: flex;
        justify-content: flex-end;
    }
    .message-actions form {
        margin-left: 5px;
    }
</style>
    <style>
        /* Modal (Widget) Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); /* Black background with opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .date-heading {
    color: #FF0000; /* Use red-orange, or replace with a preferred shade */
    font-weight: bold;
    text-align: center;
    margin-top: 20px;
/*    margin: 15px 0; */
    font-size: 14px;
/*    background-color: #fff7e6; 
    padding: 5px 10px;
    border-radius: 10px;
    display: inline-block; */
}


.read {
    background-color: green; /* Color for read */
    border-radius: 50%;
}

.unread {
    background-color: black; /* Color for unread */
    border-radius: 50%;
}
    </style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentVisibleForms = [];

        document.querySelectorAll('.direct-chat-msg').forEach(function(msg) {
            msg.addEventListener('contextmenu', function(e) {
                e.preventDefault();

                // Select all action buttons within the message
                const actionForms = msg.querySelectorAll('form[id^="deletemessage_"], form[id^="editmessage_"], form[id^="pinmessage_"], form[id^="pinmessage1_"], form[id^="starmessage_"], form[id^="starmessage1_"]');
                
                // If any forms are visible, hide them, else show all for this message
                if (Array.from(actionForms).some(form => form.style.display === 'block')) {
                    hideAllButtons();
                    currentVisibleForms = [];
                } else {
                    hideAllButtons();
                    actionForms.forEach(form => form.style.display = 'block');
                    currentVisibleForms = actionForms;
                }
            });
        });

        // Hide buttons when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.direct-chat-msg')) {
                hideAllButtons();
                currentVisibleForms = [];
            }
        });

        function hideAllButtons() {
            document.querySelectorAll('form[id^="deletemessage_"], form[id^="editmessage_"], form[id^="pinmessage_"], form[id^="pinmessage1_"], form[id^="starmessage_"], form[id^="starmessage1_"]').forEach(function(form) {
                form.style.display = 'none';
            });
        }
    });

$(document).on('keydown', function(event) {
    if (event.key === 'Enter' || $('#message').is(':focus')) {
        event.preventDefault();
        $('#send').click();  // Replace #send with the actual ID of your submit button
    }
});


</script>
  <body class="skin-black">
    <div class="wrapper">
      
      <header class="main-header">
        <!-- Logo -->
        <a href="{% url 'client' %}" class="logo" style="color: orange;"><img src="{% static 'dashboard/dist/img/site_sync_logo.png' %}" style="width: 120px; position: relative; top: -8px;"></a>
        <!-- Header Navbar: style can be found in header.less -->
        <nav class="navbar navbar-static-top" role="navigation">
          <!-- Sidebar toggle button-->
<!--           <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
            <span class="sr-only">Toggle navigation</span>
          </a> -->
          <div class="navbar-custom-menu">
                        <ul class="nav navbar-nav">
{% include 'notifications.html' %}
              <!-- User Account: style can be found in dropdown.less -->
              <li class="dropdown user user-menu">
                <a href="{% url 'profile' %}" class="dropdown-toggle">
                  <img src="{{ MEDIA_URL }}{{ auth_user.profile.profile_picture }}" class="user-image" alt="User Image"/>
                  <span class="hidden-xs">{{ fname }}</span>
                </a>
              </li>
              <!-- Sign Out  -->
              <li class="dropdown tasks-menu">
                <a href="{% url 'logout' %}" class="dropdown-toggle">
                  <i class="fa fa-power-off"></i>
                </a>
              </li> 
            </ul>
          </div>
        </nav>
      </header>
      <!-- Left side column. contains the logo and sidebar -->
      <aside class="main-sidebar">

      </aside>

      <!-- Right side column. Contains the navbar and content of the page -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header" style="position: relative; left: -690px;">
          <h1>
            <small></small>
          </h1>
          <ol class="breadcrumb">
            <li><a href="{% url 'client' %}"><i class="fa fa-dashboard"></i> Home</a></li>
            <li><a href="{% url 'client' %}">My Projects</a></li>
            <li class="active">{{ project.project_name }}</li>
          </ol>
        </section>

        <!-- Main content -->
        <section class="content">
          <div class="row">
            <div class="col-md-3">
              <div class="box box-solid">
                <div class="box-header with-border">


            <a href="{% url 'client' %}" onMouseOver="this.style.color='black'" onMouseOut="this.style.color='white'" class="btn btn-primary btn-block margin-bottom" style="color: white; font-weight: bold;">Home <i class="fa fa-home"></i></a> 
              <a href="{% url 'project_detail' project.project_id %}" onMouseOver="this.style.color='black'" onMouseOut="this.style.color='white'" class="btn btn-primary btn-block margin-bottom" style="color: white; font-weight: bold;">Back <i class="fa fa-mail-reply"></i></a>   
          </div>
                <div class="box-header with-border">
                  <h3 class="box-title">List of Project Members</h3>
                </div>
                <div class="box-body no-padding">
                  <ul class="nav nav-pills nav-stacked">
                    <li>              <!-- DIRECT CHAT -->
              <div id="myDirectChat" class="box box-warning direct-chat direct-chat-warning">
                <div class="box-body"  style="overflow-y: auto; box-sizing: border-box; max-height: 400px;">
                  <!-- Conversations are loaded here -->
                  <div style="margin-bottom: 10px;" class="direct-chat-messages">
                    <!-- Message. Default to the left -->
                    <div class="direct-chat-msg">
{% if project.leader_id != auth_user.id %}
    <img class="direct-chat-img" src="{{ leader_profile.profile_picture.url }}" alt="message user image" style="border: 2px solid orange;
    border-radius: 50%;
    padding: 3px;" />
    <span class='direct-chat-name pull-left'>{{ leader_profile.user.first_name }} (Project Leader)</span>
{% if leader_user.online == 0 %}
<a id="status" href="" title="Offline"><i class="fa fa-circle" style="color: red;"></i> </a>
{% else %}
<a id="status" href="" title="Online"><i class="fa fa-circle text-success"></i> </a>
{% endif %}
                        <form method="GET" action="{% url 'chat' project.pk %}">
                        <div>
                            <input type="radio" style="display: none;" name="members[]" value="{{ leader_profile.user.id }}" id="member_{{ leader_profile.user.id }}" checked>
                            <!-- <label for="member_{{ member.id }}">{{ member.first_name }} ({{ member.user_type }})</label> -->
                        </div>
                    <button type="submit" class="btn btn-primary" title="Filter Messages" style=" font-size: 12px;"><i class="fa fa-filter"></i></button>
                </form>
{% endif %}                  
                    </div><!-- /.direct-chat-msg -->
                    <div class="direct-chat-msg">
                    {% for member in project_member_details %}                      
                      <img class="direct-chat-img" src="{{ member.image }}" alt="message user image" /><!-- /.direct-chat-img --><span class='direct-chat-name pull-left'>{{ member.first_name }} ({{ member.user_type }})</span>
                      {% if member.online == 1 %}
<a id="status" href="" title="Online Since: {{ member.logged_in }}">  <i class="fa fa-circle text-success"></i> </a>
{% else %}
<a id="status" href="" title="Last Online At: {{ member.logged_out }}">  <i class="fa fa-circle" style="color: black;"></i> </a>
{% endif %}
                      {% if project.leader_id == auth_user.id %}
                      {% if member_status == "Accepted" %}
                      <form method="POST" name="remove_project_member_form" action="{% url 'remove_project_member' project.pk %}" enctype="multipart/form-data">
                              {% csrf_token %}
                              <input type="hidden" value="{{ member.id }}" name="uid" required>
                              <button type="submit" onclick="return confirm('Are You Sure You Want To Remove This Project Member ?')" class="btn btn-primary"style="font-size:12px;" title="Remove From Project"><i class="fa fa-remove" ></i></button>
                            </form>
                        {% else %}
                        <span class='direct-chat-name pull-left' style="color: orange;">Pending Invitation Acceptance</span>
                        {% endif %}
                        {% elif member.id == auth_user.id %}
                      <form method="POST" name="remove_project_member_form" action="{% url 'exit_project' project.pk %}" enctype="multipart/form-data">
                              {% csrf_token %}
                              <input type="hidden" value="{{ member.id }}" name="uid" required>
                              <button type="submit" onclick="return confirm('Are You Sure You Want To Exit This Project ?')" class="btn btn-primary"style="font-size:12px;" title="Exit Project"><i class="fa fa-sign-out" ></i></button>
                            </form>                      
                        {% endif %}
                                                <form method="GET" action="{% url 'chat' project.pk %}">

                    {% if member.id != auth_user.id %}
                        <div>
                            <input type="checkbox" style="display: none;" name="members[]" value="{{ member.id }}" id="member_{{ member.id }}" checked>
                            <!-- <label for="member_{{ member.id }}">{{ member.first_name }} ({{ member.user_type }})</label> -->
                        </div>
                    {% endif %}
                    <button type="submit" class="btn btn-primary" title="Filter Messages" style=" font-size: 12px;"><i class="fa fa-filter"></i></button>
                </form>
                                                    <br>
                            <br>  
                            <br>
{% endfor %}                      
                    </div><!-- /.direct-chat-msg -->
                  </div><!-- /.direct-chat-pane -->
                </div><!-- /.box-body -->
              </div><!--/.direct-chat --></li>
                    <li class="{% if filter_type == 'all' %}active{% endif %}"><a href="?filter=all"><i class="fa fa-comment"></i> All Chats</a></li>
                    <li class="{% if filter_type == 'bookmarked' %}active{% endif %}"><a href="?filter=bookmarked"><i class="fa fa-star"></i> Starred Chats</a></li>
                  </ul>
                </div><!-- /.box-body -->
              </div><!-- /. box -->
                <!-- /.box-body -->
              <!-- </div> -->
              <!-- /.box -->
            </div><!-- /.col -->
            <div class="col-md-9">
              <!-- DIRECT CHAT -->
            {% load tz %} 
              <div id="myDirectChat" class="box box-warning direct-chat direct-chat-warning">
<div class="chat-box">


<!-- Pinned Messages Section -->
        <!-- New search form -->
<!--                         <form method="GET" action="{% url 'chat' project.pk %}">
                    {% for member in project_member_details %}
                    {% if member.id != auth_user.id %}
                        <div>
                            <input type="radio" name="members[]" value="{{ member.id }}" id="member_{{ member.id }}">
                            <label for="member_{{ member.id }}">{{ member.first_name }} ({{ member.user_type }})</label>
                        </div>
                    {% endif %}
                    {% endfor %}
                    <button type="submit" class="btn btn-primary">Filter Messages</button>
                </form> -->
        <form method="get" action="{% url 'chat' project.pk %}" class="form-inline" style="width: 300px; margin-top: 10px; margin-left: 720px;">
            <div class="input-group">
                <input type="text" class="form-control input-sm" name="search" placeholder="Search Chat Message(s)..." value="{{ request.GET.search }}">
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-search"></span></button>
                </span>
            </div>
        </form>
<div style="max-height: 100px; overflow-y: auto;border-bottom: 1px solid #ddd; margin-top: 10px; margin-right: 20px;">
    <h4><b>Pinned Messages</b></h4>  
    {% for pinned_message in pinned_messages %}  
<div class="pinned-messages" style=" padding-bottom: 10px; margin-bottom: 10px;">
        <div class="pinned-message">
            <span>{{ pinned_message.sender_user.first_name }}: {{ pinned_message.message }}</span>
            <button class="btn btn-primary" 
                    onclick="document.getElementById('unpinmessage_{{ pinned_message.chat_id }}').submit();" title="Unpin A Message">
                <span class="glyphicon glyphicon-pushpin"></span>
            </button>
            <form id="unpinmessage_{{ pinned_message.chat_id }}" method="POST" action="{% url 'unpin_message' project.pk %}" style="display: none;">
                {% csrf_token %}
                <input type="hidden" name="chat_id" value="{{ pinned_message.chat_id }}">
            </form>
        </div>
</div>
    {% endfor %}
</div>

<!-- Chat Messages Section -->

<div class="chat-messages" style="overflow-y: auto; box-sizing: border-box; max-height: 450px;">
    {% for date, messages in grouped_messages.items %}
    <br>
        <div class="date-section" style="text-align: center; color: red;">
            <strong>{{ date }}</strong>
        </div>
            {% for message in messages %}
            {% if message.timestamp|localtime <= now %}
            {% if message.sender_user == auth_user %}
                <!-- Message to the right -->
                <div class="direct-chat-msg right" style="width: 92%;" title="Right Click Me to Edit!">
                    <div class='direct-chat-info clearfix'>
                        <br>
                        <span class='direct-chat-name pull-right'>Me</span>
                        <span class='direct-chat-timestamp pull-right' style="position: relative; right: 30px;">
                            {{ message.timestamp|date:"h:i a" }}
                        </span>
                    </div>
<img class="direct-chat-img" src="{{MEDIA_URL}}{{ auth_user.profile.profile_picture }}" alt="message user image" />
                    <div class="direct-chat-text pull-right">
                        {% if message.reply %}
                            <div class="reply-preview" style="background-color: #f1f1f1; padding: 5px; margin-bottom: 5px; color: black;">
                                <strong>Replying to:</strong> {{ message.reply|safe }}
                            </div>
                        {% endif %}
                        {{ message.message|safe }}
{% if message.file %}
    <hr>
    <div style="display: flex; align-items: center;" title="Click To Download Me!">
        <a href="{{ MEDIA_URL }}{{ message.file }}" style="color: white; font-weight: bold;" download>
        {% if message.file_extension in "png jpg jpeg" %}
            <!-- Image Preview -->
            <img src="{{ MEDIA_URL }}{{ message.file }}" alt="Image preview" style="max-width: 100px; max-height: 100px; margin-right: 10px;">
        {% elif message.file_extension == "pdf" %}
            <!-- PDF Icon -->
            <i class="fa fa-file-pdf-o" style="font-size: 24px; margin-right: 10px;"></i>
        {% elif message.file_extension in "doc docx" %}
            <!-- Word Icon -->
            <i class="fa fa-file-word-o" style="font-size: 24px; margin-right: 10px;"></i>
        {% elif message.file_extension in "xls xlsx" %}
            <!-- Excel Icon -->
            <i class="fa fa-file-excel-o" style="font-size: 24px; margin-right: 10px;"></i>
        {% else %}
            <!-- Default File Icon -->
            <i class="fa fa-file-o" style="font-size: 24px; margin-right: 10px;"></i>
        {% endif %}
        <!-- File download link -->
</a>
    </div>
{% endif %}

                        <br>
                        {% if message.updated_at %}
                            <span class='direct-chat-timestamp pull-right' style="color: white; font-size: 8px;">
                                Edited At: {{ message.updated_at|date:"h:i a" }}
                            </span>
                        {% endif %}
                                                {% if message.chat_id in bookmarked_chat_ids %}
        <form method="post" action="{% url 'unbookmark_message' project.pk %}">
          {% csrf_token %}
        <button type="submit" class="btn btn-link" style="padding: 0; border: none; background: none;">
        <input type="hidden" name="chat_id" value="{{ message.chat_id }}">
        <i style="color: black;" class="fa fa-star"></i>
    </button>
  </form>
  {% endif %}
                    </div>
<div class="message-actions">
  <form method="POST" name="update_project_member_form" action="{% url 'delete_message' project.pk %}" enctype="multipart/form-data" id="deletemessage_{{ message.chat_id }}" style="display: none; position: relative; right: 20px;" class="pull-right">
                              {% csrf_token %}
                              <input type="hidden" value="{{ message.chat_id }}" name="mid" required>
                              <button type="submit" onclick="return confirm('Are You Sure You Want To Delete This Message ?')"  class="btn btn-primary"><i class="fa fa-trash-o"></i></button>
                            </form>
<form method="POST" action="{% url 'edit_message' project.pk %}" enctype="multipart/form-data" id="editmessage_{{ message.chat_id }}" style="display: none; position: relative; right: 20px;" class="pull-right">
    {% csrf_token %}
    <input type="hidden" value="{{ message.chat_id }}" name="mid" required>
    <input type="text" name="edited_message" value="{{ message.message }}" required>
    <button type="submit" class="btn btn-primary"><i class="fa fa-edit"></i></button>
</form>
  <form id="pinmessage_{{ message.chat_id }}" method="POST" action="{% url 'pin_message' project.pk %}" style="display: none; position: relative; right: 20px;" class="pull-right">
                            {% csrf_token %}
                            <input type="hidden" name="chat_id" value="{{ message.chat_id }}">
<button class="btn btn-primary" onclick="document.getElementById('pinmessage_{{ message.chat_id }}').submit();" title="Pin A Message">
                            <span class="glyphicon glyphicon-pushpin"></span>
                        </button>
                        </form>
  <form id="starmessage_{{ message.chat_id }}" method="POST" action="{% url 'bookmark_message' project.pk %}" style="display: none; position: relative; right: 20px;" class="pull-right">
                            {% csrf_token %}
                            <input type="hidden" name="chat_id" value="{{ message.chat_id }}">
<button class="btn btn-primary" onclick="document.getElementById('starmessage_{{ message.chat_id }}').submit();" title="Star A Message">
                            <i class="fa fa-star"></i>
                        </button>
                        </form>
 <button class="btn btn-secondary btn-sm" onclick="replyToMessage({{ message.chat_id }}, '{{ message.message|escapejs }}')">Reply</button>
</div>
                </div>
            {% else %}
                <!-- Message to the left -->
                <div class="direct-chat-msg" style="width: 45%; position: relative; left: 12px;">
                    <div class='direct-chat-info clearfix'>
                        <span class='direct-chat-name pull-left'>{{ message.sender_user.first_name }}</span>
                        <span class='direct-chat-timestamp pull-right'>{{ message.timestamp|date:"h:i a" }}</span>
                    </div>
                    <img class="direct-chat-img" src="{{MEDIA_URL}}{{ message.sender_user.profile.profile_picture }}" alt="message user image" />
                    <div class="direct-chat-text">
                        {% if message.reply %}
                            <div class="reply-preview" style="background-color: #f1f1f1; padding: 5px; margin-bottom: 5px; color: black;">
                                <strong>Replying to:</strong> {{ message.reply|safe }}
                            </div>
                        {% endif %}
                        {{ message.message|safe }}
{% if message.file %}
    <hr>
    <div style="display: flex; align-items: center;" title="Click To Download Me!">
        <a href="{{ MEDIA_URL }}{{ message.file }}" style="color: white; font-weight: bold;" download>        
        {% if message.file_extension in "png jpg jpeg" %}
            <!-- Image Preview -->
            <img src="{{ MEDIA_URL }}{{ message.file }}" alt="Image preview" style="max-width: 100px; max-height: 100px; margin-right: 10px;">
        {% elif message.file_extension == "pdf" %}
            <!-- PDF Icon -->
            <i class="fa fa-file-pdf-o" style="font-size: 24px; margin-right: 10px;"></i>
        {% elif message.file_extension in "doc docx" %}
            <!-- Word Icon -->
            <i class="fa fa-file-word-o" style="font-size: 24px; margin-right: 10px;"></i>
        {% elif message.file_extension in "xls xlsx" %}
            <!-- Excel Icon -->
            <i class="fa fa-file-excel-o" style="font-size: 24px; margin-right: 10px;"></i>
        {% else %}
            <!-- Default File Icon -->
            <i class="fa fa-file-o" style="font-size: 24px; margin-right: 10px;"></i>
        {% endif %}
        <!-- File download link -->
</a>
    </div>
{% endif %}

                        <br>
                        {% if message.updated_at %}
                            <span class='direct-chat-timestamp pull-right' style="color: black; font-size: 8px;">
                                Edited At: {{ message.updated_at|date:"h:i a" }}
                            </span>
                            <br>
                        {% endif %}
                        {% if message.chat_id in bookmarked_chat_ids %}
        <form method="post" action="{% url 'unbookmark_message' project.pk %}">
          {% csrf_token %}
        <button type="submit" class="btn btn-link" style="padding: 0; border: none; background: none;">
        <input type="hidden" name="chat_id" value="{{ message.chat_id }}">
        <i class="fa fa-star" style="color: red;"></i>
    </button>
  </form>
  {% endif %}
                    </div>
<div class="message-actions">
  <form id="pinmessage1_{{ message.chat_id }}" method="POST" action="{% url 'pin_message' project.pk %}" style="display: none; position: relative; left: 90px; top: -45px;" class="pull-right">
                            {% csrf_token %}
                            <input type="hidden" name="chat_id" value="{{ message.chat_id }}">
<button class="btn btn-primary" onclick="document.getElementById('pinmessage1_{{ message.chat_id }}').submit();" title="Pin A Message">
                            <span class="glyphicon glyphicon-pushpin"></span>
                        </button>
                        </form>
  <form id="starmessage1_{{ message.chat_id }}" method="POST" action="{% url 'bookmark_message' project.pk %}" style="display: none; position: relative; left: 100px; top: -45px;" class="pull-right">
                            {% csrf_token %}
                            <input type="hidden" name="chat_id" value="{{ message.chat_id }}">
<button class="btn btn-primary" onclick="document.getElementById('starmessage1_{{ message.chat_id }}').submit();" title="Star A Message">
                            <i class="fa fa-star"></i>
                        </button>
                        </form>
 <button class="btn btn-secondary btn-sm" onclick="replyToMessage({{ message.chat_id }}, '{{ message.message|escapejs }}')">Reply</button>
</div>
                </div>
            {% endif %}
            {% endif %}
        {% endfor %}
    {% endfor %}
</div>


<div class="box-footer">
    <form method="POST" name="send_message_form" id="send_message_form" action="{% url 'send_message' project.pk %}" enctype="multipart/form-data" accept-charset="UTF-8">
        <div id="replySection" style="display: none; margin-bottom: 10px; padding: 10px; border-top: 1px solid #ddd;">
            <strong>Replying to: <span id="replyMessageContent"></span></strong>
            <button type="button" class="btn btn-secondary btn-sm" onclick="cancelReply()">Cancel Reply</button>
            <input type="hidden" id="replyMessageId" name="reply_message_id" value="">
        </div>

        {% csrf_token %}
        <div class="input-group">
            <span class="input-group-btn">
                <label title="Add An Attachment" for="files" class="btn btn-warning btn-flat"><i class="fa fa-paperclip"></i></label>
                <div style="display: none;">
                    <input type="file" id="files" name="file" style="visibility:hidden;" class="btn btn-warning btn-flat">
                    <input type="hidden" value="{{ auth_user.id }}" name="uid" required>
                </div>
            </span>

        <input class="form-control chat-input chatMessage" required id="message" name="message" placeholder="Type message..."/>
        <input type="hidden" value="{{ auth_user.id }}" name="uid" required>
            <span class="input-group-btn">
                <button type="submit" title="Send A Message" class="btn btn-warning btn-flat" id="send"><i class="fa fa-send-o"></i></button>
            </span>
            <span class="input-group-btn">
                <button type="button" class="btn btn-warning btn-flat" title="Schedule A Message" onclick="toggleSchedule()"><i class="fa fa-clock-o"></i></button>
            </span>
            <span class="input-group-btn">
                <button type="button" class="btn btn-warning btn-flat" title="Select Recipient(s)/Member(s)" onclick="openSelectMembers()"><i class="fa fa-users"></i></button>
            </span>
        </div>

        <div id="scheduleFields" class="modal">
            <div class="modal-content">
                <span class="close" onclick="toggleSchedule()">&times;</span>
                <h2>Schedule Details</h2>
                <label for="date">Date:</label>
                <input type="date" min="{{ day }}" id="date" name="scheduled_date"><br><br>
                <label for="time">Time:</label>
                <input type="time" id="time" name="scheduled_time"><br><br>
                <button type="button" class="btn btn-primary" onclick="toggleSchedule()">Done</button>
            </div>
        </div>

        <!-- File Preview Modal -->
        <div id="filePreviewModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeFilePreview()">&times;</span>
                <h2>File Preview</h2>
                <div id="previewContent"></div>
            </div>
        </div>

        <!-- Select Members Modal -->
<div id="selectMembersModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeSelectMembers()">&times;</span>
        <h2>Select Project Members</h2>
        <ul id="membersList">
            <!-- Add "All Users" option at the top -->
            <li>
                <input type="radio" name="selected_members[]" value="all" id="member_all">
                <label for="member_all">
                    <strong>All Users</strong>
                </label>
            </li>
            <hr> <!-- Visual separator -->
            {% for user in all_chat_members %}
                <li>
                    <input type="radio" name="selected_members[]" value="{{ user.id }}" id="member_{{ user.id }}">
                    <label for="member_{{ user.id }}">
                        {{ user.first_name }} {{ user.last_name }}
                        {% if user.is_leader %}
                            <span class="badge badge-primary">Project Leader</span>
                        {% endif %}
                    </label>
                </li>
            {% endfor %}
        </ul>
        <button type="button" class="btn btn-primary" onclick="submitMemberSelection()">Done</button>
    </div>
</div>

    </form>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const sendMessageUrl = "{% url 'send_message' project.pk %}";

document.getElementById('files').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const previewContent = document.getElementById('previewContent');

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContent.innerHTML = `<img src="${e.target.result}" style="max-width: 100%;">`;
            document.getElementById('filePreviewModal').style.display = 'block';
        }
        reader.readAsDataURL(file);
    }
});

function closeFilePreview() {
    document.getElementById('filePreviewModal').style.display = 'none';
}

function prepareSubmission() {
    openSelectMembers();
}

function openSelectMembers() {
    document.getElementById('selectMembersModal').style.display = 'block';
}

function closeSelectMembers() {
    document.getElementById('selectMembersModal').style.display = 'none';
}

function submitMemberSelection() {
    // Get the form and create FormData
    const form = document.forms['send_message_form'];
    const formData = new FormData(form);
    
    // Get selected radio button value
    const selectedOption = document.querySelector('input[name="selected_members[]"]:checked');
    
    if (!selectedOption) {
        alert('Please select a recipient option');
        return;
    }
    
    // Clear any existing selected_members entries
    formData.delete('selected_members[]');
    
    if (selectedOption.value === 'all') {
        // If "All Users" is selected, don't append any specific member IDs
        // The backend will handle this case
        formData.append('selected_members[]', 'all');
    } else {
        // Append the selected member ID
        formData.append('selected_members[]', selectedOption.value);
    }

    // Send the request
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.ok) {
            window.location.href = form.action.replace('send_message', 'chat');
        } else {
            response.text().then(text => {
                console.error('Error sending message:', text);
                alert('Error sending message. Please try again.');
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending message. Please try again.');
    });

    closeSelectMembers();
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// $(document).ready(function() {
//     $('#send_message_form').on('submit', function(event) {
//         event.preventDefault(); // Prevent the form from submitting normally

//         const messageInput = $('#message');
//         const messageContent = messageInput.val().trim(); // Get message content

//         // Get the selected members
//         const selectedOption = $('input[name="selected_members[]"]:checked');
        
//         if (!selectedOption.length) {
//             alert('Please select a recipient option');
//             return;
//         }

//         const formData = $(this).serializeArray(); // Serialize form data

//         // Determine the member selection
//         if (selectedOption.val() === 'all') {
//             // If "All Users" is selected
//             formData.push({ name: 'selected_members[]', value: 'all' });
//         } else {
//             // Append the selected member ID
//             formData.push({ name: 'selected_members[]', value: selectedOption.val() });
//         }

//         // Use the generated URL here
//         const sendMessageUrl = "{% url 'send_message' project.pk %}"; // Adjust this if needed

//         $.ajax({
//             url: sendMessageUrl,
//             type: 'POST',
//             data: formData,
//             headers: {
//                 'X-CSRFToken': '{{ csrf_token }}', // Include CSRF token
//             },
//             success: function(data) {
//                 // Handle successful message send
//                 const messagesDiv = $('#messages');
//                 const newMessageDiv = $('<div></div>').html(`<strong>${data.user}:</strong> ${data.content} <small>${data.timestamp}</small>`);
//                 messagesDiv.append(newMessageDiv);
                
//                 // Clear the input
//                 messageInput.val(''); // Clear the message input
//                 closeSelectMembers(); // Close the modal if necessary
//             },
//             error: function(xhr, status, error) {
//                 // Handle errors
//                 console.error("Error:", error);
//                 alert("There was a problem sending your message. Please try again.");
//             }
//         });
//     });

    // Add keydown event to submit the form when Enter is pressed
// $(document).ready(function() {
//     // Bind form submission to Enter key using keyup
//     $('#send_message_form').on('keyup', function(event) {
//         if (event.key === 'Enter') {
//             event.preventDefault(); // Prevent default line break behavior
//             $('#send_message_form').trigger('submit'); // Manually trigger form submission
//         }
//     });

//     // Handle form submission
//     $('#send_message_form').on('submit', function(event) {
//         event.preventDefault(); // Prevent default submission for validation

//         // Capture data for debugging
//         const messageContent = $('#message').val().trim();
//         const replyMessageId = $('#replyMessageId').val();
//         const fileInput = $('#files').val();

//         // Log data to ensure values are being captured
//         console.log("Raw Message Content:", messageContent);
//         console.log("Reply Message ID:", replyMessageId);
//         console.log("File Input:", fileInput);

//         // Check if required data (like message) is present
//         if (!messageContent) {
//             alert("Message cannot be empty.");
//             return; // Stop the submission if the message is empty
//         }

//         // Submit the form after validation
//         this.submit(); // Proceed with the form submission
//     });
// });

// $(document).ready(function () {
//     // Trigger form submission on Enter key press
//     $('#send_message_form').on('keydown', function (event) {
//         if (event.key === 'Enter') {
//             event.preventDefault(); // Prevents default new line behavior
//             $('#send_message_form').trigger('submit'); // Triggers form submission
//             $('#send_message_form').trigger('submit');
//             document.getElementById("send_message_form").reset();

//         }
//     });

//     // Handle form submission
//     $('#send_message_form').on('submit', function (event) {
//         event.preventDefault(); // Prevent default form submission for AJAX handling

//         // Retrieve form data
//         const messageContent = $('#message').val().trim();
//         const replyMessageId = $('#replyMessageId').val();
//         const fileInput = $('#files')[0].files[0]; // Capture file from input

//         console.log(messageContent);

//         // Basic validation: Ensure message is not empty
//         if (!messageContent) {
//             return;
//             $('#send_message_form').trigger('submit');
//         }

//         // Create a FormData object to handle the file upload and other data
//         const formData = new FormData();
//         formData.append('message', messageContent);
//         formData.append('reply_message_id', replyMessageId || '');
//         formData.append('uid', $('input[name="uid"]').val()); // Include user ID
//         if (fileInput) {
//             formData.append('file', fileInput);
//         }

//         // Append CSRF token
//         formData.append('csrfmiddlewaretoken', $('input[name="csrfmiddlewaretoken"]').val());

//         // Optional: Append schedule date and time if provided
//         const scheduledDate = $('#date').val();
//         const scheduledTime = $('#time').val();
//         if (scheduledDate && scheduledTime) {
//             formData.append('scheduled_date', scheduledDate);
//             formData.append('scheduled_time', scheduledTime);
//         }

//         // Send AJAX request
//         $.ajax({
//             url: $('#send_message_form').attr('action'),
//             method: 'POST',
//             data: formData,
//             processData: false, // Important for FormData
//             contentType: false, // Important for FormData
//             success: function (response) {
//                 // Handle successful submission
//                 console.log("Message sent successfully:", response);
//                 $('#message').val(''); // Clear input field
//                 $('#replyMessageId').val(''); // Clear reply ID if any
//                 $('#files').val(''); // Reset file input
//             },
//             error: function (xhr) {
//                 // Handle error
//                 alert("An error occurred while sending the message.");
//                 console.error("Error details:", xhr.responseText);
//             }
//         });
//     });
// });

</script>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
}
</style>



</div>
            </div><!-- /.col -->
          </div><!-- /.row -->

        </section><!-- /.content -->
      </div><!-- /.content-wrapper -->
<footer class="main-footer">
        <strong>Copyright <span id="year"></span>. <a href="">The Bengal Tigers 🐅</a>.</strong>
      </footer>
    </div><!-- ./wrapper -->

    <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
    <script>
      $.widget.bridge('uibutton', $.ui.button);
    </script>
<script type="text/javascript">
function replyToMessage(messageId, messageContent) {
    document.getElementById('replySection').style.display = 'block';
    document.getElementById('replyMessageId').value = messageId;
    document.getElementById('replyMessageContent').innerText = messageContent;
}

function cancelReply() {
    document.getElementById('replySection').style.display = 'none';
    document.getElementById('replyMessageId').value = '';
    document.getElementById('replyMessageContent').innerText = '';
}
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 3.3.2 JS -->
    <script src="{% static 'dashboard/bootstrap/js/bootstrap.min.js' %}" type="text/javascript"></script>    
    <!-- Morris.js charts -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
    <script src="{% static 'dashboard/plugins/morris/morris.min.js' %}" type="text/javascript"></script>
    <!-- Sparkline -->
    <script src="{% static 'dashboard/plugins/sparkline/jquery.sparkline.min.js' %}" type="text/javascript"></script>
    <!-- jvectormap -->
    <script src="{% static 'dashboard/plugins/jvectormap/jquery-jvectormap-1.2.2.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'dashboard/plugins/jvectormap/jquery-jvectormap-world-mill-en.js' %}" type="text/javascript"></script>
    <!-- jQuery Knob Chart -->
    <script src="{% static 'dashboard/plugins/knob/jquery.knob.js' %}" type="text/javascript"></script>
    <!-- daterangepicker -->
    <script src="{% static 'dashboard/plugins/daterangepicker/daterangepicker.js' %}" type="text/javascript"></script>
    <!-- datepicker -->
    <script src="{% static 'dashboard/plugins/datepicker/bootstrap-datepicker.js' %}" type="text/javascript"></script>
    <!-- Bootstrap WYSIHTML5 -->
    <script src="{% static 'dashboard/plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.all.min.js' %}" type="text/javascript"></script>
    <!-- iCheck -->
    <script src="{% static 'dashboard/plugins/iCheck/icheck.min.js' %}" type="text/javascript"></script>
    <!-- Slimscroll -->
    <script src="{% static 'dashboard/plugins/slimScroll/jquery.slimscroll.min.js' %}" type="text/javascript"></script>
    <!-- FastClick -->
    <script src="{% static 'dashboard/plugins/fastclick/fastclick.min.js' %}"></script>
    <!-- Site Sync App -->
    <script src="{% static 'dashboard/dist/js/app.min.js' %}" type="text/javascript"></script>

    <!-- Site Sync dashboard demo (This is only for demo purposes) -->
    <script src="{% static 'dashboard/dist/js/pages/dashboard.js' %}" type="text/javascript"></script>

    <!-- Site Sync for demo purposes -->
    <!-- <script src="{% static 'dashboard/dist/js/demo.js' %}" type="text/javascript"></script> -->

      <script type="text/javascript">
         new Date().getFullYear()
document.getElementById("year").innerHTML = new Date().getFullYear();

$("#files").change(function() {
  filename = this.files[0].name;
  console.log(filename);
});

</script>
<script>
    function toggleSchedule() {
        var scheduleFields = document.getElementById('scheduleFields');
        if (scheduleFields.style.display === 'none') {
            scheduleFields.style.display = 'block';
        } else {
            scheduleFields.style.display = 'none';
        }
    }
              $(document).ready(function() {
    $("body").addClass('sidebar-collapse'); // Add collapse class on page load
  });
</script>
<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Include EmojioneArea CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.1.0/emojionearea.min.css">

<!-- Include EmojioneArea JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.1.0/emojionearea.min.js"></script>

<script>
$(document).ready(function() {
  console.log("jQuery is loaded:", !!$);
  console.log("emojioneArea is loaded:", !!$.fn.emojioneArea);
  $('#message').emojioneArea({
    pickerPosition: "down",
    tonesStyle: "bullet"
  });
});

</script>
<script type="text/javascript">
// let lastMessageId = 0;
const currentUserId = {{ currentUserId }};
const MEDIA_URL = '{{ MEDIA_URL }}';

// Initialize event listeners
function initializeEventListeners() {
    document.addEventListener('contextmenu', function(e) {
        const messageElement = e.target.closest('.direct-chat-msg');
        if (messageElement) {
            e.preventDefault();
            hideAllButtons();

            const actionForms = messageElement.querySelectorAll(
                'form[id^="deletemessage_"], form[id^="editmessage_"], ' +
                'form[id^="pinmessage_"], form[id^="pinmessage1_"], ' +
                'form[id^="starmessage_"], form[id^="starmessage1_"]'
            );

            actionForms.forEach(form => {
                form.style.display = (form.style.display === 'block') ? 'none' : 'block';
            });
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.direct-chat-msg')) {
            hideAllButtons();
        }
    });
}

function hideAllButtons() {
    document.querySelectorAll(
        'form[id^="deletemessage_"], form[id^="editmessage_"], ' +
        'form[id^="pinmessage_"], form[id^="pinmessage1_"], ' +
        'form[id^="starmessage_"], form[id^="starmessage1_"]'
    ).forEach(form => {
        form.style.display = 'none';
    });
}

// Function to format each message and return HTML
// Message formatter utility class
class MessageFormatter {
    constructor(currentUserId, mediaUrl) {
        this.currentUserId = currentUserId;
        this.mediaUrl = mediaUrl;
        this.initializeEventListeners();
    }

    // Initialize global event listeners
    initializeEventListeners() {
        // Handle right-click on messages
        document.addEventListener('contextmenu', (e) => {
            const messageElement = e.target.closest('.direct-chat-msg');
            if (messageElement) {
                e.preventDefault();
                this.hideAllActionForms();
                
                // Show action forms for the right-clicked message
                const actionForms = messageElement.querySelectorAll(
                    'form[id^="deletemessage_"], form[id^="editmessage_"], ' +
                    'form[id^="pinmessage_"], form[id^="pinmessage1_"], ' +
                    'form[id^="starmessage_"], form[id^="starmessage1_"]'
                );
                
                actionForms.forEach(form => {
                    form.style.display = 'block';
                });
            }
        });

        // Hide action forms when clicking outside messages
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.direct-chat-msg')) {
                this.hideAllActionForms();
            }
        });
    }

    // Hide all action forms
    hideAllActionForms() {
        document.querySelectorAll(
            'form[id^="deletemessage_"], form[id^="editmessage_"], ' +
            'form[id^="pinmessage_"], form[id^="pinmessage1_"], ' +
            'form[id^="starmessage_"], form[id^="starmessage1_"]'
        ).forEach(form => {
            form.style.display = 'none';
        });
    }

    // Format message and return HTML
// Define lastDisplayedDate at the class level (outside of the function)
lastDisplayedDate = null;

// Format message and return HTML with date heading
formatMessage(message, projectPk) {
    const isOwnMessage = message.sender_user.id === this.currentUserId;
    const messageDate = new Date(message.timestamp);
    // const messageDateString = messageDate.toLocaleDateString(undefined, { 
    //     day: 'numeric', month: 'short', year: 'numeric' 
    // });
    const day = messageDate.getDate(); // Get the day of the month (1-31)
const monthIndex = messageDate.getMonth(); // Get the month index (0-11)
const year = messageDate.getFullYear(); // Get the full year (YYYY)

// Create an array of short month names
const shortMonthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                         "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// Construct the date string
const messageDateString = `${day} ${shortMonthNames[monthIndex]} ${year}`;


    const messageContainer = document.createElement('div');

    // If this message's date is different from the last displayed date, add a date heading
    if (this.lastDisplayedDate !== messageDateString) {
        const dateHeading = document.createElement('div');
        dateHeading.className = 'date-heading';
        dateHeading.textContent = messageDateString;

        messageContainer.appendChild(dateHeading);
        this.lastDisplayedDate = messageDateString;  // Update last displayed date
    }

    // Create main message container
    const messageDiv = document.createElement('div');
    messageDiv.className = `direct-chat-msg ${isOwnMessage ? 'right' : ''}`;
    messageDiv.style.width = isOwnMessage ? '92%' : '45%';
    messageDiv.dataset.messageId = message.chat_id;
    messageDiv.title = "Right Click Me to Edit!";

    if (!isOwnMessage) {
        messageDiv.style.position = 'relative';
        messageDiv.style.left = '12px';
    }

    // Construct message HTML
    messageDiv.innerHTML = `
        ${this.createMessageHeader(message, isOwnMessage, messageDate)}
        ${this.createUserAvatar(message)}
        ${this.createMessageContent(message, isOwnMessage)}
        ${this.createActionForms(message, projectPk, isOwnMessage)}
    `;

    // Append message to the message container
    messageContainer.appendChild(messageDiv);

    return messageContainer;
}

    // Create message header
    createMessageHeader(message, isOwnMessage, messageDate) {
        return `
            <div class='direct-chat-info clearfix'>
                <span class='direct-chat-name ${isOwnMessage ? 'pull-right' : 'pull-left'}'>
                    ${isOwnMessage ? 'Me' : message.sender_user.first_name}
                </span>
                <span class='direct-chat-timestamp ${isOwnMessage ? 'pull-right' : 'pull-left'}'
                      style="${isOwnMessage ? 'position: relative; right: 30px;' : ''}">
                    ${messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </span>
            </div>
        `;
    }

    // Create user avatar
    createUserAvatar(message) {
        const profilePicture = message.sender_user.profile_picture || '${this.mediaUrl}default-profile.png';
        return `
            <img class="direct-chat-img" 
                 src="${profilePicture}" 
                 alt="message user image" />
        `;
    }


    // Create message content
    createMessageContent(message, isOwnMessage) {
        console.log('Is Bookmarked:', message.is_bookmarked);
        return `
            <div class="direct-chat-text ${isOwnMessage ? 'pull-right' : ''}">
                ${this.createReplyPreview(message)}
                ${message.message}
                ${this.createFileAttachment(message)}
                ${this.createEditedTimestamp(message, isOwnMessage)}
                ${this.createStarForm(message, message.projectPk, isOwnMessage)}
                ${isOwnMessage ? this.createReadReceipts(message) : ''}
            </div>
        `;
    }

// Create read receipts (ticks)
createReadReceipts(message) {
    let receipts = '';
    if (message.read_status && Array.isArray(message.read_status)) {
        // Filter users by read/unread status
        const readUsers = message.read_status
            .filter(userStatus => userStatus.status === 0)
            .map(userStatus => userStatus.username)
            .join(', ');

        const unreadUsers = message.read_status
            .filter(userStatus => userStatus.status === 1)
            .map(userStatus => userStatus.username)
            .join(', ');

        // Tooltip text for read and unread statuses
        const titleText = unreadUsers 
            ? `Unread by: ${unreadUsers}` 
            : `Read by: ${readUsers}`;

        // Show checkmark if all have read, X if any have not read
        const tick = unreadUsers 
            ? `<span class="tick unread" title="${titleText}">&#10007;</span>`  // X if unread
            : `<span class="tick read" title="${titleText}">&#10003;</span>`;   // ✓ if all read

        receipts += `<div class="user-read-status">${tick}</div>`;
    }
    return `
        <div class="read-receipts">
            ${receipts}
        </div>
    `;
}

    // Create action forms
    createActionForms(message, projectPk, isOwnMessage) {
        if (isOwnMessage) {
            return `
                <div class="message-actions" style="position: relative; ${isOwnMessage ? 'right: 20px;' : ''}">
                    ${this.createDeleteForm(message, projectPk)}
                    ${this.createEditForm(message, projectPk)}
                    ${this.createPinForm(message, projectPk)}
                    ${this.createStarForm1(message, projectPk)}
                    ${this.createStarForm(message, projectPk, false)}
                    ${this.createReplyButton(message)}
                </div>
            `;
        } else {
            return `
                <div class="message-actions">
                    ${this.createPinForm(message, projectPk, true)}
                   ${this.createStarForm1(message, projectPk)}
                    ${this.createStarForm(message, projectPk, true)}
                    ${this.createReplyButton(message)}
                </div>
            `;
        }
    }

    // Other helper methods remain the same as in previous version...
    createReplyPreview(message) {
        if (!message.reply) return '';
        return `
            <div class="reply-preview" style="background-color: #f1f1f1; padding: 5px; margin-bottom: 5px; color: black;">
                <strong>Replying to:</strong> ${message.reply}
            </div>
        `;
    }

    createFileAttachment(message) {
        if (!message.file) return '';

        let fileContent = '';
        if (['png', 'jpg', 'jpeg'].includes(message.file_extension)) {
            fileContent = `<img src="${this.mediaUrl}${message.file}" alt="Image preview" 
                              style="max-width: 100px; max-height: 100px; margin-right: 10px;">`;
        } else {
            const iconClass = {
                'pdf': 'fa-file-pdf-o',
                'doc': 'fa-file-word-o',
                'docx': 'fa-file-word-o',
                'xls': 'fa-file-excel-o',
                'xlsx': 'fa-file-excel-o'
            }[message.file_extension] || 'fa-file-o';
            
            fileContent = `<i class="fa ${iconClass}" style="font-size: 24px; margin-right: 10px;"></i>`;
        }

        return `
            <hr>
            <div style="display: flex; align-items: center;" title="Click To Download Me!">
                <a href="${this.mediaUrl}${message.file}" style="color: white; font-weight: bold;" download>
                    ${fileContent}
                </a>
            </div>
        `;
    }

    createEditedTimestamp(message, isOwnMessage) {
        if (!message.updated_at) return '';
        return `
            <br>
            <span class='direct-chat-timestamp pull-right' 
                  style="color: ${isOwnMessage ? 'white' : 'black'}; font-size: 8px;">
                Edited At: ${new Date(message.updated_at)
                    .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </span>
        `;
    }

    createDeleteForm(message, projectPk) {
        return `
            <form method="POST" 
                  action="/projects/${projectPk}/deletemessage/"
                  id="deletemessage_${message.chat_id}" 
                  style="display: none;">
                <input type="hidden" value="${message.chat_id}" name="mid" required>

                <button type="submit" 
                        onclick="return confirm('Are You Sure You Want To Delete This Message?')"
                        class="btn btn-primary">
                    <i class="fa fa-trash-o"></i>
                </button>
            </form>
        `;
    }

    createEditForm(message, projectPk) {
        return `
            <form method="POST" 
                  action="/projects/${projectPk}/edit_message/"
                  id="editmessage_${message.chat_id}" 
                  style="display: none;">
                <input type="hidden" value="${message.chat_id}" name="mid" required>

                <input type="text" name="edited_message" value="${message.message.replace(/"/g, '&quot;')}" required>
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-edit"></i>
                </button>
            </form>
        `;
    }

createStarForm1(message, projectPk, isOtherUser = false) {
    const formId = isOtherUser ? `starmessage1_${message.chat_id}` : `starmessage_${message.chat_id}`;
    const style = isOtherUser ? 
        'display: none; position: relative; left: 90px; top: -45px;' : 
        'display: none;';
        
    return `
        <form method="POST" 
              action="/projects/${projectPk}/bookmark_message/"
              id="${formId}" 
              style="${style}" 
              class="pull-right">
            <input type="hidden" name="chat_id" value="${message.chat_id}">

            <button class="btn btn-warning" title="Star A Message">
                <span class="glyphicon glyphicon-star"></span>
            </button>
        </form>
    `;
}


    createPinForm(message, projectPk, isOtherUser = false) {
        const formId = isOtherUser ? `pinmessage1_${message.chat_id}` : `pinmessage_${message.chat_id}`;
        const style = isOtherUser ? 
            'display: none; position: relative; left: 90px; top: -45px;' : 
            'display: none;';
            
        return `
            <form method="POST" 
                  action="/projects/${projectPk}/pin_message/"
                  id="${formId}" 
                  style="${style}" 
                  class="pull-right">
                <input type="hidden" name="chat_id" value="${message.chat_id}">

                <button class="btn btn-primary" title="Pin A Message">
                    <span class="glyphicon glyphicon-pushpin"></span>
                </button>
            </form>
        `;
    }

createStarForm(message, projectPk, isOwnMessage) {
    // Only show the star form if the message is bookmarked
    if (!message.is_bookmarked) {
        return ''; // Return an empty string if the message is not bookmarked
    }

    // Check if projectPk is valid
    if (!projectPk) {
        console.error('projectPk is undefined'); // Log error if projectPk is not defined
        return ''; // Return nothing if projectPk is not available
    }

    const formAction = `/projects/${projectPk}/unbookmark_message/`; // Set the action for unbookmarking
    const chatIdInput = `<input type="hidden" name="chat_id" value="${message.chat_id}">`;
    const starColor = isOwnMessage ? 'black' : 'red'; // Set star color based on the sender
    const starIcon = `<i class="fa fa-star" style="color: ${starColor};"></i>`; // Star icon with dynamic color

    return `
        <form method="POST" action="${formAction}">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"> <!-- Assuming CSRF token is available in your context -->
            ${chatIdInput}
            <button type="submit" class="btn btn-link" style="padding: 0; border: none; background: none;">
                ${starIcon}
            </button>
        </form>
    `;
}

    createReplyButton(message) {
        return `
            <button class="btn btn-secondary btn-sm" 
                    onclick="replyToMessage(${message.chat_id}, '${message.message.replace(/'/g, "\\'")}')">
                Reply
            </button>
        `;
    }
}

// Usage:
const formatter = new MessageFormatter(currentUserId, MEDIA_URL);
let lastMessageId = 0;
let isFetching = false;

function updateMessages(messages, projectPk) {
    const chatMessages = document.querySelector('.chat-messages');
    const shouldScroll = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 100;

    // Clear all existing messages in the chat container
    chatMessages.innerHTML = '';

    // Append each message in the fetched batch
    messages.forEach(message => {
        const messageElement = formatter.formatMessage(message, projectPk);
        messageElement.setAttribute('data-chat-id', message.chat_id); // Track message ID on the element
        chatMessages.appendChild(messageElement);
        
        // Update lastMessageId to the highest ID found in this batch
        lastMessageId = Math.max(lastMessageId, message.chat_id);
    });

    if (shouldScroll) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function fetchNewMessages() {
    if (isFetching) return;
    isFetching = true;

    const chatUrl = window.location.pathname;
    const projectPk = chatUrl.split('/')[2];

    $.ajax({
        url: chatUrl,
        type: 'GET',
        data: { last_message_id: lastMessageId },
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success && Array.isArray(response.messages)) {
                updateMessages(response.messages, projectPk);
                console.log(response.messages);
            } else {
                console.error("Unexpected response format:", response);
            }
            isFetching = false;
        },
        error: function(xhr, status, error) {
            console.error('Error fetching messages:', error);
            isFetching = false;
        }
    });
}




// Initialize fetching messages on document ready
$(document).ready(function() {
    initializeEventListeners();
    {% if filter_type != 'bookmarked' %}
    setInterval(fetchNewMessages, 3000);
    {% endif %}
});

</script>
  </body>
</html>

